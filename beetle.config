/* Block 1: User parameters
-------------------------------------------------------------------
-- Change these at will */

// Input + Output
params {

  /* Project name
  -- This is used to structure output, as well as cache and working directories. */
  project    = "BarkBeetle_2022"

  /* Area of Interest
  -- This should be a vector polygon file with the boundary of your study area.
  -- It is used to determine the processing extent. */
  aoi = '/data/ahsoka/eocp/borkenkaefer/hungry-beetle/input/rlp.gpkg'

  /* Analysis mask
  -- This should be a either a vector polygon file with areas that should be analyzed,
  -- or a raster mask datacube ready for usage with FORCE.
  -- Ideally, it should only contain areas with spruce trees. */
  mask {
    is_vector = false
    directory = '/data/ahsoka/eocp/klehr/RLP_SynthMix/00_needle_mask'
    file = 'Copernicus_HRL_needlemask.tif'
  }

  /* FORCE Data Cube
  -- This should be a Level 2 ARD Data Cube generated by FORCE 
  -- D. Frantz (2019): FORCE â€“ Landsat + Sentinel-2 Analysis Ready Data and beyond. 
  -- Remote Sensing 11, 1124. https://doi.org/10.3390/rs11091124
  -- Code: https://github.com/davidfrantz/force */
  datacube = '/data/ahsoka/dc/deu/ard'

  /* Working directory 
  -- Do not delete if you want to resume workflow at a later stage. */
  working = '/nvme1/ahsoka/gi-sds/hungry-beetle-workdir'

  /* Output directory
  -- Will contain all workflow output and details on workflow execution.
  -- Do not delete ``.nextflow`` directory if you want to resume workflow at a later stage. */
  publish= '/data/ahsoka/eocp/borkenkaefer/hungry-beetle/output'

}

// Study period
params {

  /* Start + end of the reference period 
  -- The reference period is used to characterize the "usual" phenology of spruce trees.
  -- It is assumed that no disturbance happened during this period. */
  reference_start = '2015'
  reference_end   = '2017'

  /* Start + end of the monitoring period 
  -- The monitoring period is used to detect disturbances, i.e.,
  -- observations that notably and persistently differ from the "usual" phenology. 
  -- The monitoring period starts after the reference period. */
    monitor_end = '2023'

  /* Seasonal window
  -- This is used to restrict the analysis to a suitable part of the year, e.g.,
  -- to exclude winter observations. Values are in Day-of-Year format. */
  season_start    = 106
  //season_start    = 150
  season_end      = 274

}

// Earth Observation data (see FORCE documentation)
params {

  /* Sensors to used */
  sensors = 'SEN2A SEN2B'

  /* Analysis resolution */
  resolution = 10

  /* Spectral Index */
  index = 'CRemoveSWIR1'

}

// detection thresholds
params {

  /* residuals should be x times larger than the standard deviation in the reference period */
  thr_std = 3

  /* residuals need to be at least this high */
  thr_min = 200

  /* threshold test direction: gt = +1 | lt = -1 */
  thr_direction = 1

  /* minimum mapping unit in pixels */
  mmu = 10

}

// Multithreading parameters
params {

  /* Number of CPUs
  -- Maximum number of CPUs that shall be used by multithreaded processes. 
  -- Give a higher number for small AOIs, and a lower number for large AOIs.
  -- But keep reading speed, as well as available RAM in mind! */
  max_cpu = 20

}


/* Block 2: Workflow Management System parameters
-------------------------------------------------------------------
-- Leave these on default unless you know what to do */

process {
  cpus = 1
  withLabel: 'multithread' { cpus = params.max_cpu }
}

process {
  errorStrategy = 'retry'
  maxRetries = 3
}

docker {
  enabled = true
  runOptions = '-u $(id -u):$(id -g)'
}

process {
  container = 'ubuntu:22.04'
  withLabel: 'force'  { container = 'davidfrantz/force:dev'}
  withLabel: 'rstats' { container = 'davidfrantz/rstats'}
  withLabel: 'beetle' { container = 'davidfrantz/hungry-beetle'}
  withLabel: 'mmu'    { container = 'davidfrantz/mmu'}
}

dag {
  enabled = true
  overwrite = true
  file = "$params.publish/$params.project/workflow_dag.html"
}

report {
  enabled = true
  overwrite = true
  file = "$params.publish/$params.project/workflow_report.html"
}

timeline {
  enabled = true
  overwrite = true
  file = "$params.publish/$params.project/workflow_timeline.html"
}

workDir = "$params.working/$params.project"
